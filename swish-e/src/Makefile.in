# 
# Makefile derived from the Makefile coming with swish-e 1.3.2
# (original Makefile for SWISH Kevin Hughes, 3/12/95)
#
# The code has been tested to compile on Solaris and DEC 
# G.Hill ghill@library.berkeley.edu 6/11/97
# 
# autoconf configuration by Bas Meijer, 11 Dec 2000
# Cross Platform Compilation on Solaris, HP-UX, IRIX, Mac OS X, BDSi and Linux
# Several ideas from a Makefile by Christian Lindig <lindig@ips.cs.tu-bs.de>  
#
# $Id$

# get name and version from configure.in
NAME        = @PROJECT@
VERSION     = @VERSION@

# C compiler
CC          = @CC@

SHELL       = @SHELL@
top_srcdir  = @top_srcdir@
prefix      = @prefix@
bindir      = @bindir@
exec_prefix = @exec_prefix@
libdir      = @libdir@
includedir  = @includedir@
cflags      = @CFLAGS@
ldflags     = @LDFLAGS@

INSTALL         = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_SCRIPT  = @INSTALL_SCRIPT@
INSTALL_DATA    = @INSTALL_DATA@
MKINSTALLDIRS   = $(SHELL) $(top_srcdir)/mkinstalldirs



LIBS        = @LIBS@ @LIBXML2_LIB@ @Z_LIBS@ @PCRE_LIBS@

SEARCHLIBS  = @LIBS@ @Z_LIBS@ @PCRE_LIBS@

# Library related 
AR          = ar
ARFLAGS     = cr
RANLIB      = @RANLIB@

#
# The objects for the different methods and
# some common aliases
#



#--- James Clark's Expat ----

XPDIR       = expat

XP_OBJ = $(XPDIR)/xmltok/xmltok.o \
         $(XPDIR)/xmltok/xmlrole.o \
         $(XPDIR)/xmlparse/xmlparse.o

XP_INC = -I$(XPDIR)/xmltok -I$(XPDIR)/xmlparse

XP_H   = $(XPDIR)/xmltok/*.h $(XPDIR)/xmlparse/*.h


#== Define groups of object files ==

#--- Input methods ---
FILESYSTEM_OBJS     = fs.o
HTTP_OBJS           = http.o httpserver.o
EXTPROG_OBJS        = extprog.o
INPUT_METHODS_OBJS  = $(FILESYSTEM_OBJS) $(HTTP_OBJS) $(EXTPROG_OBJS) methods.o

#--- Parsers ---
PARSER_OBJS         = html.o txt.o xml.o $(XP_OBJ) entities.o @LIBXML2_OBJS@
                      

#--- Logical Groups of modules ---

INDEXING_OBJS       = $(INPUT_METHODS_OBJS) $(PARSER_OBJS) \
                      index.o merge.o  pre_sort.o file.o \
                      filter.o parse_conffile.o swregex.o \
                      db_write.o docprop_write.o


SEARCHING_OBJS      = swish2.o search.o swish_words.o proplimit.o \
                      rank.o db_read.o result_sort.o

# search_alt.o - removed 9/2002, was not implemented                      

#--- Common modules --

DB_OBJS             = hash.o compress.o db_native.o ramdisk.o btree.o array.o worddata.o fhash.o

UTIL_OBJS           = check.o error.o list.o mem.o string.o \
                      docprop.o metanames.o headers.o \
                      swish_qsort.o  date_time.o \
                      double_metaphone.o stemmer.o soundex.o \
                      no_better_place_module.o @LIBOBJS@


# Only for building the binary

SWISH_BINARY_OBJS   = swish.o keychar_out.o dump.o result_output.o  $(INDEXING_OBJS)


# Collection of files for building swish search library

LIB_OBJS     = $(SEARCHING_OBJS) $(DB_OBJS) $(UTIL_OBJS)

# All objects for make clean target
OBJS                = $(SEARCHING_OBJS) $(DB_OBJS) $(UTIL_OBJS) $(INDEXING_OBJS)  $(SWISH_BINARY_OBJS) 

SWISH_BIN = $(NAME)@EXEEXT@
SWISHSEARCH_BIN = swish-search@EXEEXT@
LIBTEST_BIN = libtest@EXEEXT@
 
# Flags for C compiler
CFLAGS      = -Wall @DEFS@ -DSWISH_VERSION=\"$(VERSION)\" $(XP_INC) @LIBXML2_CFLAGS@ @Z_CFLAGS@ @PCRE_CFLAGS@ $(cflags)
LDFLAGS     = $(ldflags)




#.SUFFIXES: 
#.SUFFIXES : .o .c

.c.o:
	$(CC) $(CFLAGS) -c -o $@ $<
	
all:	$(NAME)

$(NAME): libswish-e.a $(SWISH_BINARY_OBJS)
	$(CC) -o $(SWISH_BIN) $(CFLAGS) $(LDFLAGS) $(SWISH_BINARY_OBJS) libswish-e.a $(LIBS)
	chmod 755 $(SWISH_BIN)

libswish-e.a: $(LIB_OBJS)
	$(AR) $(ARFLAGS) $@ $(LIB_OBJS)
	$(RANLIB) libswish-e.a

swish-search: $(NAME)
	cp -f $(SWISH_BIN) $(SWISHSEARCH_BIN)

clean:
	rm -f ../tests/*.index ../tests/core core $(SWISH_BIN) $(SWISHSEARCH_BIN) $(LIBTEST_BIN) swish.o $(OBJS) libswish-e.a libsearchswish-e.a libtest.o

realclean: clean
	rm Makefile
	rm -f config.cache config.log config.status

test:	$(NAME)
	@echo -e "\nCreating index..."
	@(cd ../tests; ../src/swish-e -c test.config)

	@echo -e "\n** Five (5) tests follow..."

	@echo -e "\ntest 1 (Normal search) ..."
	@(cd ../tests; ../src/swish-e -f ./test.index -w test | egrep  '^[0-9]')
	
	@echo -e "\ntest 2 (MetaTag search 1) ..."
	@(cd ../tests; ../src/swish-e -f ./test.index -w meta1=metatest1 | egrep  '^[0-9]')
	
	@echo -e "\ntest 3 (MetaTag search 2) ..."
	@(cd ../tests; ../src/swish-e -f ./test.index -w meta2=metatest2 | egrep  '^[0-9]')
	
	@echo -e "\ntest 4 (XML search) ..."
	@(cd ../tests; ../src/swish-e -f ./test.index -w meta3=metatest3 | egrep  '^[0-9]')
	
	@echo -e "\ntest 5 (Phrase search) ..."
	@(cd ../tests; ../src/swish-e -f ./test.index -w '"three little pigs"' | egrep  '^[0-9]')

	@echo -e "\n ** All tests completed! **\n"


$(LIB_OBJS):	Makefile config.h swish.h

install: $(NAME) install-lib
	$(MKINSTALLDIRS) $(bindir)
	$(INSTALL_PROGRAM) $(SWISH_BIN) $(bindir)/$(SWISH_BIN)

install-lib: libswish-e.a
	$(MKINSTALLDIRS) $(libdir) $(includedir)
	$(INSTALL_PROGRAM) libswish-e.a $(libdir)/libswish-e.a
	$(INSTALL_DATA) swish-e.h $(includedir)/swish-e.h


libtest: libswish-e.a libtest.o
	$(CC) -o $(LIBTEST_BIN) $(CFLAGS) $(LDFLAGS) libtest.o libswish-e.a $(SEARCHLIBS)
	chmod 755 $(LIBTEST_BIN)





#
# dependencies
# 
*.o: *.h

*.c: *.h

$(XPDIR)/xmltok/*.o: $(XPDIR)/xmltok/*.h
$(XPDIR)/xmlparse/*.o: $(XPDIR)/xmlparse/*.h


