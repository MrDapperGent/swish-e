# 
# Makefile derived from the Makefile coming with swish-e 1.3.2
# (original Makefile for SWISH Kevin Hughes, 3/12/95)
#
# The code has been tested to compile on Solaris and DEC 
# G.Hill ghill@library.berkeley.edu 6/11/97
# 
# autoconf configuration by Bas Meijer, 11 Dec 2000
# Cross Platform Compilation on Solaris, HP-UX, IRIX, Mac OS X, BDSi and Linux
# Several ideas from a Makefile by Christian Lindig <lindig@ips.cs.tu-bs.de>  
#
# $Id$

# get name and version from configure.in
NAME        = @PROJECT@
VERSION     = @VERSION@

# C compiler
CC          = @CC@

SHELL       = /bin/sh
prefix      = @prefix@
bindir      = $(prefix)/bin
exec_prefix = @exec_prefix@
libdir      = @libdir@
cflags      = @CFLAGS@
ldflags     = @LDFLAGS@


# libxml2 -- uncomment to enable
#LIBXML2_OBJS = parser.o
#LIBXML2_LIB  = -lxml2
#LIBXML2_CFLAGS = -DLIBXML2


LIBS        = @LIBS@ $(LIBXML2_LIB)

# Library related 
AR          = ar
ARFLAGS     = cr
RANLIB      = @RANLIB@

#
# The objects for the different methods and
# some common aliases
#

FILESYSTEM_OBJS=fs.o
HTTP_OBJS   =http.o httpserver.o 
FS_OBJS     =$(FILESYSTEM_OBJS)
WEB_OBJS    =$(HTTP_OBJS)


# James Clark's Expat

XPDIR       = expat

XP_OBJ = $(XPDIR)/xmltok/xmltok.o \
         $(XPDIR)/xmltok/xmlrole.o \
         $(XPDIR)/xmlparse/xmlparse.o

XP_INC = -I$(XPDIR)/xmltok -I$(XPDIR)/xmlparse

XP_H   = $(XPDIR)/xmltok/*.h $(XPDIR)/xmlparse/*.h


 
# Flags for C compiler
CFLAGS      = -Wall @DEFS@ -DSWISH_VERSION=\"$(VERSION)\" $(XP_INC) $(LIBXML2_CFLAGS) $(cflags)
LDFLAGS     = $(ldflags)


OBJS=	$(LIBXML2_OBJS) check.o file.o index.o search.o error.o methods.o\
	hash.o list.o mem.o string.o merge.o swish2.o stemmer.o \
	soundex.o docprop.o compress.o xml.o txt.o html.o\
	metanames.o result_output.o parse_conffile.o result_sort.o\
	filter.o search_alt.o keychar_out.o date_time.o \
	extprog.o entities.o no_better_place_module.o \
	db.o dump.o db_native.o swish_words.o proplimit.o swish_qsort.o \
	ramdisk.o \
	$(FILESYSTEM_OBJS) $(HTTP_OBJS) $(XP_OBJ)


#.SUFFIXES: 
#.SUFFIXES : .o .c

.c.o:
	$(CC) $(CFLAGS) -c -o $@ $<
	
all:	$(NAME)

$(NAME): libswish-e.a swish.o
	$(CC) -o $@ $(CFLAGS) $(LDFLAGS) swish.o libswish-e.a $(LIBS)
	chmod 755 $@

libswish-e.a: $(OBJS)
	$(AR) $(ARFLAGS) $@ $(OBJS)
	$(RANLIB) libswish-e.a

swish-search: $(NAME)
	cp -f $(NAME) swish-search

clean:
	rm -f ../tests/*.index ../tests/core core  swish-e swish-search swish.o $(OBJS) libswish-e.a

realclean: clean
	rm Makefile
	rm -f config.cache config.log config.status

test:	$(NAME)
	@echo -e "\nCreating index..."
	@(cd ../tests; ../src/swish-e -c test.config)

	@echo -e "\n** Five (5) tests follow..."

	@echo -e "\ntest 1 (Normal search) ..."
	@(cd ../tests; ../src/swish-e -f ./test.index -w test | egrep  '^[0-9]')
	
	@echo -e "\ntest 2 (MetaTag search 1) ..."
	@(cd ../tests; ../src/swish-e -f ./test.index -w meta1=metatest1 | egrep  '^[0-9]')
	
	@echo -e "\ntest 3 (MetaTag search 2) ..."
	@(cd ../tests; ../src/swish-e -f ./test.index -w meta2=metatest2 | egrep  '^[0-9]')
	
	@echo -e "\ntest 4 (XML search) ..."
	@(cd ../tests; ../src/swish-e -f ./test.index -w meta3=metatest3 | egrep  '^[0-9]')
	
	@echo -e "\ntest 5 (Phrase search) ..."
	@(cd ../tests; ../src/swish-e -f ./test.index -w '"three little pigs"' | egrep  '^[0-9]')

	@echo -e "\n ** All tests completed! **\n"


$(OBJS):	Makefile config.h swish.h

install:
	cp swish-e $(bindir)/swish-e

install-lib:	
	cp libswish-e.a $(libdir)/libswish-e.a


#
# dependencies
# 
*.o: *.h

*.c: *.h

$(XPDIR)/xmltok/*.o: $(XPDIR)/xmltok/*.h
$(XPDIR)/xmlparse/*.o: $(XPDIR)/xmlparse/*.h


